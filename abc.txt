ä½ è¦å°†æ–°é—»å­˜å…¥ PostgreSQL çš„ pgvector æ•°æ®åº“ä¸­ï¼Œå¹¶ç¡®ä¿æ–°é—»å†…å®¹ä¸é‡å¤ï¼Œå¯ä»¥é‡‡ç”¨ä»¥ä¸‹ç­–ç•¥å’ŒæŠ€æœ¯æ–¹æ¡ˆï¼š

---

## ğŸ“Œ æŠ€æœ¯æ–¹æ¡ˆæ€è·¯ï¼š

### æ­¥éª¤ä¸€ï¼šæ•´ä½“æ€è·¯

* **è®¡ç®—å‘é‡ä¹‹å‰å…ˆæ£€æŸ¥æ–‡æœ¬æœ¬èº«çš„å”¯ä¸€æ€§**ï¼Œç”¨å“ˆå¸Œï¼ˆhashï¼‰æ–¹å¼å…ˆå¿«é€Ÿå»é‡ã€‚
* å¦‚æœæ–°é—»æ–‡æœ¬ä¸é‡å¤ï¼Œå†è®¡ç®—å…¶åµŒå…¥å‘é‡ã€‚
* å­˜å‚¨æ–°é—»æ–‡æœ¬ã€å‘é‡å’Œæ–‡æœ¬å“ˆå¸Œåˆ° pgvector æ•°æ®åº“ã€‚
* **å‘é‡ç›¸ä¼¼åº¦**æ£€æŸ¥ï¼Œç”¨äºé¿å…è¯­ä¹‰ç›¸åŒä½†æ–‡å­—è¡¨è¿°ç¨æœ‰å˜åŒ–çš„æ–°é—»é‡å¤å…¥åº“ï¼ˆé€‰åšï¼‰ã€‚

---

## ğŸ“Œ å…·ä½“å®ç°ï¼ˆç»“åˆ LangChain å’Œ PostgreSQL + pgvectorï¼‰ï¼š

### 1ï¸âƒ£ æ•°æ®åº“è®¾è®¡

åˆ›å»ºä¸€ä¸ªå­˜å‚¨æ–°é—»æ–‡æœ¬ã€å‘é‡åŠå“ˆå¸Œçš„è¡¨ï¼š

```sql
CREATE EXTENSION IF NOT EXISTS vector;

CREATE TABLE news_articles (
    id SERIAL PRIMARY KEY,
    content TEXT UNIQUE,             -- å”¯ä¸€çº¦æŸé˜²æ­¢å®Œå…¨ç›¸åŒæ–‡æœ¬
    content_hash TEXT UNIQUE,        -- å“ˆå¸Œç”¨äºå¿«é€Ÿå»é‡
    embedding VECTOR(1536),          -- å‡è®¾ä½¿ç”¨ OpenAI embeddings é»˜è®¤ç»´åº¦ 1536
    created_at TIMESTAMP DEFAULT NOW()
);

-- ä¸ºå‘é‡åˆ›å»ºç´¢å¼•ä»¥æé«˜å‘é‡æœç´¢é€Ÿåº¦
CREATE INDEX news_embedding_idx ON news_articles USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);
```

**è§£é‡Š**ï¼š

* `content` ä½¿ç”¨ `UNIQUE` ç¡®ä¿æ–‡æœ¬æœ¬èº«çš„å”¯ä¸€æ€§ã€‚
* `content_hash` ä¸ºå¿«é€Ÿå»é‡æä¾›äº†é«˜æ•ˆæ–¹å¼ï¼ˆæ–‡æœ¬è¾ƒé•¿æ—¶æ€§èƒ½æ›´ä½³ï¼‰ã€‚
* `embedding` å­˜å‚¨æ–‡æœ¬å‘é‡ã€‚
* å‘é‡ç´¢å¼• (`ivfflat`) ç”¨äºé«˜æ•ˆç›¸ä¼¼æ€§æœç´¢ã€‚

---

### 2ï¸âƒ£ ä½¿ç”¨ LangChain è®¡ç®— Embeddings å’Œå“ˆå¸Œ

å®‰è£…ä¾èµ–ï¼š

```bash
pip install langchain openai psycopg[binary] pgvector
```

ç¤ºä¾‹ Python ä»£ç å®ç°ï¼š

```python
from langchain_openai import OpenAIEmbeddings
import psycopg
import hashlib

# åˆå§‹åŒ–Embedding
embeddings = OpenAIEmbeddings(model="text-embedding-ada-002")

# PostgreSQLæ•°æ®åº“è¿æ¥
conn = psycopg.connect("postgresql://user:password@host:port/dbname")

def hash_content(content):
    """ç”Ÿæˆå†…å®¹çš„å“ˆå¸Œå€¼"""
    return hashlib.sha256(content.encode('utf-8')).hexdigest()

def insert_news_article(content):
    """æ’å…¥æ–°é—»æ–‡ç« å¹¶ç¡®ä¿ä¸é‡å¤"""
    content_hash = hash_content(content)

    with conn.cursor() as cur:
        # é¦–å…ˆå¿«é€Ÿåˆ¤æ–­å“ˆå¸Œå€¼æ˜¯å¦å·²å­˜åœ¨
        cur.execute("SELECT id FROM news_articles WHERE content_hash = %s", (content_hash,))
        if cur.fetchone():
            print("é‡å¤çš„æ–‡ç« ï¼Œè·³è¿‡æ’å…¥")
            return

        # è®¡ç®—æ–‡æœ¬Embedding
        embedding = embeddings.embed_query(content)

        # æ’å…¥åˆ°æ•°æ®åº“
        cur.execute(
            "INSERT INTO news_articles (content, content_hash, embedding) VALUES (%s, %s, %s)",
            (content, content_hash, embedding)
        )
        conn.commit()
        print("æ–°é—»æ–‡ç« å·²æ’å…¥")

# æµ‹è¯•æ’å…¥æ–‡ç« 
sample_article = "ç¾å›½æ€»ç»Ÿå®£å¸ƒæ–°çš„ç»æµåˆºæ¿€è®¡åˆ’â€¦â€¦"
insert_news_article(sample_article)
```

---

### 3ï¸âƒ£ è¯­ä¹‰å»é‡ï¼ˆé€‰åšï¼‰

å¦‚æœä½ å¸Œæœ›é¿å…è¯­ä¹‰ç›¸è¿‘ä½†ä¸å®Œå…¨ç›¸åŒæ–‡æœ¬çš„æ–°é—»é‡å¤å…¥åº“ï¼š

å®ç°æ€è·¯ï¼š

* åœ¨æ’å…¥æ–°æ–°é—»å‰ï¼Œ**å…ˆè¿›è¡Œå‘é‡ç›¸ä¼¼åº¦æœç´¢**ï¼Œç¡®å®šç›¸ä¼¼åº¦é«˜äºæŸä¸ªé˜ˆå€¼çš„æ–‡ç« ä¸å†å…¥åº“ã€‚

```python
def is_similar_article(embedding, threshold=0.9):
    """åˆ¤æ–­æ˜¯å¦å­˜åœ¨ç›¸ä¼¼æ–‡ç« ï¼Œé˜ˆå€¼å¯è°ƒæ•´"""
    with conn.cursor() as cur:
        cur.execute("""
            SELECT id, content
            FROM news_articles
            ORDER BY embedding <=> %s
            LIMIT 1
        """, (embedding,))
        result = cur.fetchone()
        if result:
            similar_id, similar_content = result
            # è®¡ç®—å®é™…ä½™å¼¦ç›¸ä¼¼åº¦è¿›è¡Œé˜ˆå€¼åˆ¤æ–­
            cur.execute("""
                SELECT 1 - (embedding <=> %s) AS similarity
                FROM news_articles WHERE id = %s
            """, (embedding, similar_id))
            similarity = cur.fetchone()[0]
            if similarity >= threshold:
                print(f"æ‰¾åˆ°ç›¸ä¼¼æ–‡ç« ï¼ˆç›¸ä¼¼åº¦ï¼š{similarity:.4f}ï¼‰")
                return True
    return False

def insert_news_article_with_similarity_check(content, similarity_threshold=0.9):
    content_hash = hash_content(content)

    with conn.cursor() as cur:
        # å¿«é€Ÿå“ˆå¸Œåˆ¤æ–­
        cur.execute("SELECT id FROM news_articles WHERE content_hash = %s", (content_hash,))
        if cur.fetchone():
            print("æ–‡æœ¬é‡å¤ï¼Œè·³è¿‡æ’å…¥")
            return

        # è®¡ç®—Embedding
        embedding = embeddings.embed_query(content)

        # å‘é‡ç›¸ä¼¼æ€§åˆ¤æ–­
        if is_similar_article(embedding, similarity_threshold):
            print("å­˜åœ¨è¯­ä¹‰ç›¸ä¼¼æ–‡ç« ï¼Œè·³è¿‡æ’å…¥")
            return

        # æ’å…¥æ•°æ®
        cur.execute(
            "INSERT INTO news_articles (content, content_hash, embedding) VALUES (%s, %s, %s)",
            (content, content_hash, embedding)
        )
        conn.commit()
        print("æ–‡ç« æˆåŠŸæ’å…¥")

# æµ‹è¯•è¯­ä¹‰å»é‡
insert_news_article_with_similarity_check("ç¾å›½æ€»ç»Ÿå®£å¸ƒæœ€æ–°ç»æµæ”¿ç­–æ–¹æ¡ˆâ€¦â€¦")
```

---

## ğŸ“Œ æ ¸å¿ƒä¼˜åŠ¿ï¼š

* **é«˜æ•ˆå»é‡**ï¼š

  * å…ˆé€šè¿‡å“ˆå¸Œå¿«é€Ÿè¿‡æ»¤å®Œå…¨ç›¸åŒæ–‡æœ¬ã€‚
  * å†ä½¿ç”¨å‘é‡ç›¸ä¼¼åº¦è¿›è¡Œè¯­ä¹‰çº§åˆ«çš„é«˜çº§å»é‡ã€‚

* **é«˜æ•ˆå‘é‡å­˜å‚¨**ï¼š

  * ä½¿ç”¨ `pgvector` å†…ç½®çš„é«˜æ•ˆå‘é‡æœç´¢ç´¢å¼•ã€‚

* **æ˜“ç»´æŠ¤æ‰©å±•**ï¼š

  * PostgreSQL + LangChain çš„æŠ€æœ¯æ ˆå¯æ–¹ä¾¿åœ°æ‰©å±•å…¶ä»–åŠŸèƒ½ï¼ˆå¦‚æ£€ç´¢ã€èšç±»åˆ†æç­‰ï¼‰ã€‚

---

ä»¥ä¸Šæ–¹æ¡ˆï¼Œèƒ½å¤Ÿæ»¡è¶³ä½ çš„æ–°é—»æ–‡æœ¬å­˜å‚¨éœ€æ±‚ï¼ŒåŒæ—¶é€šè¿‡æ–‡æœ¬å“ˆå¸Œå’Œè¯­ä¹‰å‘é‡ç»“åˆçš„æ–¹å¼ï¼Œç¡®ä¿æ–°åŠ å…¥æ–°é—»çš„é«˜æ•ˆå»é‡ã€‚
